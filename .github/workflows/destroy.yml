name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Â¿QuÃ© quieres destruir? (Â¡CUIDADO!)'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod
          - keyvault
          - all
      confirm_destroy:
        description: 'Escribe "DESTROY" para confirmar'
        required: true
        type: string

env:
  TF_VERSION: '1.6.0'

jobs:
  terraform-destroy:
    name: Destroy ${{ matrix.environment }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ github.event.inputs.environment == 'all' && fromJSON('["dev", "stage", "prod"]') || fromJSON(format('["{0}"]', github.event.inputs.environment)) }}
    if: |
      github.event.inputs.environment != 'keyvault' &&
      (github.event.inputs.environment == 'all' ||
       github.event.inputs.environment == 'dev' ||
       github.event.inputs.environment == 'stage' ||
       github.event.inputs.environment == 'prod')
    environment:
      name: ${{ matrix.environment }}-destroy
    
    steps:
      - name: Validate Destroy Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ Debes escribir 'DESTROY' para confirmar la destrucciÃ³n"
            exit 1
          fi
          echo "âœ… ConfirmaciÃ³n de destrucciÃ³n recibida para ${{ matrix.environment }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then MISSING_SECRETS+=("AZURE_STATE_RESOURCE_GROUP"); fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then MISSING_SECRETS+=("AZURE_STATE_STORAGE_ACCOUNT"); fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then MISSING_SECRETS+=("AZURE_STATE_CONTAINER"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_ID"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_SECRET"); fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then MISSING_SECRETS+=("AZURE_SUBSCRIPTION_ID"); fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then MISSING_SECRETS+=("AZURE_TENANT_ID"); fi
          if [ -z "${{ secrets.RESOURCE_PREFIX }}" ]; then MISSING_SECRETS+=("RESOURCE_PREFIX"); fi
          if [ -z "${{ secrets.AZURE_LOCATION }}" ]; then MISSING_SECRETS+=("AZURE_LOCATION"); fi
          if [ -z "${{ secrets.CLUSTER_NAME_BASE }}" ]; then MISSING_SECRETS+=("CLUSTER_NAME_BASE"); fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=${{ matrix.environment }}/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "âœ… Estado encontrado con recursos:"
            terraform state list
          else
            echo "âš ï¸ Estado vacÃ­o o no existe - no hay nada que destruir"
            echo "âœ… Saltando destroy (no hay recursos en el estado)"
            exit 0
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Force Unlock State (if locked)
        run: |
          echo "ðŸ”“ Verificando si el estado estÃ¡ bloqueado..."
          set +e
          terraform plan \
            -var-file=environments/${{ matrix.environment }}/terraform.tfvars \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -var="cluster_name=${{ secrets.CLUSTER_NAME_BASE }}" \
            -lock=false 2>&1 | tee unlock_check.txt
          set -e
          
          if grep -q "state blob is already locked" unlock_check.txt; then
            echo "âš ï¸ Estado bloqueado detectado, extrayendo Lock ID..."
            LOCK_ID=$(grep -oP 'ID:\s+\K[a-f0-9-]+' unlock_check.txt | head -1 || echo "")
            if [ -n "$LOCK_ID" ]; then
              echo "ðŸ”“ Liberando lock: $LOCK_ID"
              terraform force-unlock -force "$LOCK_ID" || echo "âš ï¸ No se pudo liberar el lock (puede que ya estÃ© liberado)"
            fi
          else
            echo "âœ… Estado no estÃ¡ bloqueado"
          fi
          rm -f unlock_check.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Clean AKS Node Resources (if exists)
        run: |
          echo "ðŸ§¹ Limpiando recursos de nodos AKS que puedan estar bloqueando la destrucciÃ³n..."
          
          # Obtener nombres de recursos
          RESOURCE_GROUP="${{ secrets.RESOURCE_PREFIX }}-rg-${{ matrix.environment }}"
          CLUSTER_NAME="${{ secrets.CLUSTER_NAME_BASE }}-${{ matrix.environment }}"
          
          echo "ðŸ“ Resource Group del cluster: $RESOURCE_GROUP"
          echo "ðŸ“ Cluster Name: $CLUSTER_NAME"
          
          # Verificar si el cluster existe
          if az aks show --resource-group "$RESOURCE_GROUP" --name "$CLUSTER_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
            echo "âœ… Cluster AKS encontrado, eliminÃ¡ndolo primero..."
            az aks delete --resource-group "$RESOURCE_GROUP" --name "$CLUSTER_NAME" --yes --no-wait || echo "âš ï¸ Error al eliminar cluster (puede que ya estÃ© eliminado)"
            echo "â³ Esperando 30 segundos para que Azure complete la eliminaciÃ³n..."
            sleep 30
          else
            echo "â„¹ï¸ Cluster AKS no encontrado (puede que ya estÃ© eliminado)"
          fi
          
          # Buscar todos los resource groups MC_* que puedan estar relacionados
          echo "ðŸ” Buscando resource groups MC_* relacionados..."
          MC_GROUPS=$(az group list --query "[?starts_with(name, 'MC_')].name" -o tsv 2>/dev/null || echo "")
          
          RESOURCE_GROUP_UPPER=$(echo "$RESOURCE_GROUP" | tr '[:lower:]' '[:upper:]')
          CLUSTER_NAME_UPPER=$(echo "$CLUSTER_NAME" | tr '[:lower:]' '[:upper:]')
          
          FOUND_ANY=false
          if [ -n "$MC_GROUPS" ]; then
            for MC_GROUP in $MC_GROUPS; do
              # Verificar si el resource group contiene recursos relacionados con este cluster
              # Buscar por nombre del resource group o cluster (case insensitive, sin reemplazar guiones)
              MC_GROUP_UPPER=$(echo "$MC_GROUP" | tr '[:lower:]' '[:upper:]')
              
              if echo "$MC_GROUP_UPPER" | grep -qE "(${RESOURCE_GROUP_UPPER}|${CLUSTER_NAME_UPPER})"; then
                echo "âš ï¸ Resource Group de nodos encontrado: $MC_GROUP"
                echo "ðŸ—‘ï¸ Eliminando resource group de nodos..."
                az group delete --name "$MC_GROUP" --yes --no-wait || echo "âš ï¸ Error al eliminar $MC_GROUP"
                FOUND_ANY=true
              fi
            done
            
            if [ "$FOUND_ANY" = true ]; then
              echo "â³ Esperando 60 segundos para que Azure complete la eliminaciÃ³n..."
              sleep 60
            fi
          else
            echo "â„¹ï¸ No se encontraron resource groups MC_*"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Destroy
        id: destroy
        run: |
          echo "ðŸ—‘ï¸ Iniciando destrucciÃ³n de infraestructura ${{ matrix.environment }}..."
          set +e
          terraform destroy -auto-approve \
            -var-file=environments/${{ matrix.environment }}/terraform.tfvars \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -var="cluster_name=${{ secrets.CLUSTER_NAME_BASE }}" 2>&1 | tee destroy_output.txt
          DESTROY_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ "$DESTROY_EXIT_CODE" -ne 0 ]; then
            if grep -q "state blob is already locked" destroy_output.txt; then
              echo "âš ï¸ Estado aÃºn bloqueado, extrayendo Lock ID y liberando..."
              LOCK_ID=$(grep -oP 'ID:\s+\K[a-f0-9-]+' destroy_output.txt | head -1 || echo "")
              if [ -n "$LOCK_ID" ]; then
                echo "ðŸ”“ Liberando lock: $LOCK_ID"
                terraform force-unlock -force "$LOCK_ID"
                echo "ðŸ”„ Reintentando destrucciÃ³n..."
                terraform destroy -auto-approve \
                  -var-file=environments/${{ matrix.environment }}/terraform.tfvars \
                  -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
                  -var="location=${{ secrets.AZURE_LOCATION }}" \
                  -var="cluster_name=${{ secrets.CLUSTER_NAME_BASE }}"
              else
                echo "âŒ No se pudo extraer el Lock ID"
                cat destroy_output.txt
                exit 1
              fi
            elif grep -q "InUseSubnetCannotBeDeleted" destroy_output.txt; then
              echo "âš ï¸ Subnet aÃºn en uso, limpiando recursos de nodos AKS..."
              
              # Extraer el nombre del resource group MC_* directamente del mensaje de error
              MC_GROUP_FROM_ERROR=$(grep -oP 'resourceGroups/\K[^/]+' destroy_output.txt | grep "^MC_" | head -1 || echo "")
              
              if [ -n "$MC_GROUP_FROM_ERROR" ]; then
                echo "âœ… Resource Group MC_* encontrado en el error: $MC_GROUP_FROM_ERROR"
                echo "ðŸ—‘ï¸ Eliminando resource group de nodos: $MC_GROUP_FROM_ERROR"
                az group delete --name "$MC_GROUP_FROM_ERROR" --yes --no-wait || echo "âš ï¸ Error al eliminar $MC_GROUP_FROM_ERROR"
                echo "â³ Esperando 90 segundos para que Azure complete la eliminaciÃ³n..."
                sleep 90
                echo "ðŸ”„ Reintentando destrucciÃ³n..."
                terraform destroy -auto-approve \
                  -var-file=environments/${{ matrix.environment }}/terraform.tfvars \
                  -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
                  -var="location=${{ secrets.AZURE_LOCATION }}" \
                  -var="cluster_name=${{ secrets.CLUSTER_NAME_BASE }}"
              else
                # Fallback: buscar manualmente todos los MC_*
                echo "ðŸ” No se pudo extraer del error, buscando todos los resource groups MC_*..."
                RESOURCE_GROUP="${{ secrets.RESOURCE_PREFIX }}-rg-${{ matrix.environment }}"
                CLUSTER_NAME="${{ secrets.CLUSTER_NAME_BASE }}-${{ matrix.environment }}"
                
                MC_GROUPS=$(az group list --query "[?starts_with(name, 'MC_')].name" -o tsv 2>/dev/null || echo "")
                
                RESOURCE_GROUP_UPPER=$(echo "$RESOURCE_GROUP" | tr '[:lower:]' '[:upper:]')
                CLUSTER_NAME_UPPER=$(echo "$CLUSTER_NAME" | tr '[:lower:]' '[:upper:]')
                
                FOUND_MC_GROUP=false
                if [ -n "$MC_GROUPS" ]; then
                  for MC_GROUP in $MC_GROUPS; do
                    MC_GROUP_UPPER=$(echo "$MC_GROUP" | tr '[:lower:]' '[:upper:]')
                    if echo "$MC_GROUP_UPPER" | grep -qE "(${RESOURCE_GROUP_UPPER}|${CLUSTER_NAME_UPPER})"; then
                      echo "ðŸ—‘ï¸ Eliminando resource group de nodos: $MC_GROUP"
                      az group delete --name "$MC_GROUP" --yes --no-wait
                      FOUND_MC_GROUP=true
                    fi
                  done
                fi
                
                if [ "$FOUND_MC_GROUP" = true ]; then
                  echo "â³ Esperando 90 segundos para que Azure complete la eliminaciÃ³n..."
                  sleep 90
                  echo "ðŸ”„ Reintentando destrucciÃ³n..."
                  terraform destroy -auto-approve \
                    -var-file=environments/${{ matrix.environment }}/terraform.tfvars \
                    -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
                    -var="location=${{ secrets.AZURE_LOCATION }}" \
                    -var="cluster_name=${{ secrets.CLUSTER_NAME_BASE }}"
                else
                  echo "âŒ No se pudo encontrar el resource group MC_* para limpiar"
                  echo "ðŸ’¡ Intenta eliminar manualmente el resource group MC_* desde Azure Portal"
                  echo "ðŸ” Resource groups MC_* encontrados:"
                  echo "$MC_GROUPS" || echo "Ninguno"
                  cat destroy_output.txt
                  exit 1
                fi
              fi
            else
              echo "âŒ Error durante la destrucciÃ³n (cÃ³digo: $DESTROY_EXIT_CODE)"
              cat destroy_output.txt
              exit $DESTROY_EXIT_CODE
            fi
          else
            echo "âœ… DestrucciÃ³n completada exitosamente"
          fi
          rm -f destroy_output.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Updated in Backend
        run: |
          echo "ðŸ” Verificando que el estado se actualizÃ³ en Azure Storage..."
          STATE_KEY="${{ matrix.environment }}/terraform.tfstate"
          echo "ðŸ“ Ruta del estado: $STATE_KEY"
          
          # Verificar que el blob existe en el storage
          if az storage blob exists \
            --account-name "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            --container-name "${{ secrets.AZURE_STATE_CONTAINER }}" \
            --name "$STATE_KEY" \
            --auth-mode login \
            --query exists -o tsv 2>/dev/null | grep -q "true"; then
            echo "âœ… Estado verificado en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/$STATE_KEY"
            
            # Obtener informaciÃ³n del blob
            BLOB_INFO=$(az storage blob show \
              --account-name "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
              --container-name "${{ secrets.AZURE_STATE_CONTAINER }}" \
              --name "$STATE_KEY" \
              --auth-mode login \
              --query "{size:properties.contentLength,lastModified:properties.lastModified}" -o json 2>/dev/null || echo "{}")
            
            if [ "$BLOB_INFO" != "{}" ]; then
              echo "ðŸ“Š InformaciÃ³n del estado:"
              echo "$BLOB_INFO" | jq -r '"TamaÃ±o: " + (.size | tostring) + " bytes, Ãšltima modificaciÃ³n: " + .lastModified'
            fi
          else
            echo "â„¹ï¸ El estado ya no existe en el storage (normal despuÃ©s de destroy completo)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Destroy Summary
        run: |
          echo "## ðŸ—‘ï¸ Infraestructura ${{ matrix.environment }} Destruida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Entorno:** ${{ matrix.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY

  terraform-destroy-keyvault:
    name: Destroy Key Vault
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.environment == 'keyvault' || github.event.inputs.environment == 'all'
    environment:
      name: global-destroy
    
    steps:
      - name: Validate Destroy Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ Debes escribir 'DESTROY' para confirmar la destrucciÃ³n"
            exit 1
          fi
          echo "âœ… ConfirmaciÃ³n de destrucciÃ³n recibida para Key Vault"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then MISSING_SECRETS+=("AZURE_STATE_RESOURCE_GROUP"); fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then MISSING_SECRETS+=("AZURE_STATE_STORAGE_ACCOUNT"); fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then MISSING_SECRETS+=("AZURE_STATE_CONTAINER"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_ID"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_SECRET"); fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then MISSING_SECRETS+=("AZURE_SUBSCRIPTION_ID"); fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then MISSING_SECRETS+=("AZURE_TENANT_ID"); fi
          if [ -z "${{ secrets.RESOURCE_PREFIX }}" ]; then MISSING_SECRETS+=("RESOURCE_PREFIX"); fi
          if [ -z "${{ secrets.AZURE_LOCATION }}" ]; then MISSING_SECRETS+=("AZURE_LOCATION"); fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Service Principal Object ID
        id: sp_object_id
        run: |
          SP_OBJECT_ID=$(az ad sp show --id "$ARM_CLIENT_ID" --query id -o tsv)
          echo "object_id=$SP_OBJECT_ID" >> $GITHUB_OUTPUT
          echo "Service Principal Object ID: $SP_OBJECT_ID"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Init
        run: |
          cd environments/global
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=global/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Check State
        run: |
          cd environments/global
          if terraform state list 2>/dev/null | grep -q .; then
            echo "âœ… Estado encontrado con recursos:"
            terraform state list
          else
            echo "âš ï¸ Estado vacÃ­o o no existe - no hay nada que destruir"
            echo "âœ… Saltando destroy (no hay recursos en el estado)"
            exit 0
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Force Unlock State (if locked)
        run: |
          cd environments/global
          echo "ðŸ”“ Verificando si el estado estÃ¡ bloqueado..."
          set +e
          terraform destroy -auto-approve \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -lock=false 2>&1 | tee unlock_check.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if grep -q "state blob is already locked" unlock_check.txt; then
            echo "âš ï¸ Estado bloqueado detectado, extrayendo Lock ID..."
            LOCK_ID=$(grep -oP 'ID:\s+\K[^\s]+' unlock_check.txt | head -1 || echo "")
            if [ -n "$LOCK_ID" ]; then
              echo "ðŸ”“ Liberando lock: $LOCK_ID"
              terraform force-unlock -force "$LOCK_ID" || echo "âš ï¸ No se pudo liberar el lock (puede que ya estÃ© liberado)"
            fi
          fi
          rm -f unlock_check.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Destroy
        id: destroy
        run: |
          cd environments/global
          echo "ðŸ—‘ï¸ Iniciando destrucciÃ³n de Key Vault Global..."
          set +e
          terraform destroy -auto-approve \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
            -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
            -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
            -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
            -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
            -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
            -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
            -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
            -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" 2>&1 | tee destroy_output.txt
          DESTROY_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          if [ "$DESTROY_EXIT_CODE" -ne 0 ]; then
            if grep -q "state blob is already locked" destroy_output.txt; then
              echo "âš ï¸ Estado aÃºn bloqueado, extrayendo Lock ID y liberando..."
              LOCK_ID=$(grep -oP 'ID:\s+\K[a-f0-9-]+' destroy_output.txt | head -1 || echo "")
              if [ -n "$LOCK_ID" ]; then
                echo "ðŸ”“ Liberando lock: $LOCK_ID"
                terraform force-unlock -force "$LOCK_ID"
                echo "ðŸ”„ Reintentando destrucciÃ³n..."
                terraform destroy -auto-approve \
                  -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
                  -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
                  -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
                  -var="location=${{ secrets.AZURE_LOCATION }}" \
                  -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
                  -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
                  -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
                  -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
                  -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
                  -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
                  -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
                  -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
                  -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
                  -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
                  -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}"
              else
                echo "âŒ No se pudo extraer el Lock ID"
                cat destroy_output.txt
                exit 1
              fi
            else
              echo "âŒ Error durante la destrucciÃ³n (cÃ³digo: $DESTROY_EXIT_CODE)"
              cat destroy_output.txt
              exit $DESTROY_EXIT_CODE
            fi
          else
            echo "âœ… DestrucciÃ³n completada exitosamente"
          fi
          rm -f destroy_output.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Updated in Backend
        run: |
          echo "ðŸ” Verificando que el estado se actualizÃ³ en Azure Storage..."
          STATE_KEY="global/terraform.tfstate"
          echo "ðŸ“ Ruta del estado: $STATE_KEY"
          
          # Verificar que el blob existe en el storage
          if az storage blob exists \
            --account-name "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            --container-name "${{ secrets.AZURE_STATE_CONTAINER }}" \
            --name "$STATE_KEY" \
            --auth-mode login \
            --query exists -o tsv 2>/dev/null | grep -q "true"; then
            echo "âœ… Estado verificado en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/$STATE_KEY"
            
            # Obtener informaciÃ³n del blob
            BLOB_INFO=$(az storage blob show \
              --account-name "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
              --container-name "${{ secrets.AZURE_STATE_CONTAINER }}" \
              --name "$STATE_KEY" \
              --auth-mode login \
              --query "{size:properties.contentLength,lastModified:properties.lastModified}" -o json 2>/dev/null || echo "{}")
            
            if [ "$BLOB_INFO" != "{}" ]; then
              echo "ðŸ“Š InformaciÃ³n del estado:"
              echo "$BLOB_INFO" | jq -r '"TamaÃ±o: " + (.size | tostring) + " bytes, Ãšltima modificaciÃ³n: " + .lastModified'
            fi
          else
            echo "â„¹ï¸ El estado ya no existe en el storage (normal despuÃ©s de destroy completo)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Destroy Summary
        run: |
          echo "## ðŸ—‘ï¸ Key Vault Global Destruido" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recurso:** Key Vault Global" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
