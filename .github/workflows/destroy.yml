name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a destruir (Â¡CUIDADO!)'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod
          - all
      confirm_destroy:
        description: 'Escribe "DESTROY" para confirmar'
        required: true
        type: string

env:
  TF_VERSION: '1.6.0'

jobs:
  terraform-destroy-dev:
    name: Destroy Dev
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'all'
    environment:
      name: dev-destroy
    
    steps:
      - name: Validate Destroy Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ Debes escribir 'DESTROY' para confirmar la destrucciÃ³n"
            exit 1
          fi
          echo "âœ… ConfirmaciÃ³n de destrucciÃ³n recibida para dev"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "âŒ Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "âŒ Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "âŒ Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "âŒ Error: AZURE_CLIENT_ID secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then
            echo "âŒ Error: AZURE_CLIENT_SECRET secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "âŒ Error: AZURE_SUBSCRIPTION_ID secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "âŒ Error: AZURE_TENANT_ID secret is missing"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=dev/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "âœ… Estado encontrado con recursos:"
            terraform state list
          else
            echo "âš ï¸ Estado vacÃ­o o no existe - no hay nada que destruir"
            echo "âœ… Saltando destroy (no hay recursos en el estado)"
            exit 0
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Destroy
        id: destroy
        run: |
          echo "ðŸ—‘ï¸ Iniciando destrucciÃ³n de infraestructura dev..."
          terraform destroy -auto-approve -var-file=environments/dev/terraform.tfvars
          DESTROY_EXIT_CODE=$?
          if [ "$DESTROY_EXIT_CODE" -eq 0 ]; then
            echo "âœ… DestrucciÃ³n completada exitosamente"
          else
            echo "âŒ Error durante la destrucciÃ³n (cÃ³digo: $DESTROY_EXIT_CODE)"
            exit $DESTROY_EXIT_CODE
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Destroy Summary
        run: |
          echo "## ðŸ—‘ï¸ Infraestructura Dev Destruida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Entorno:** dev" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY

  terraform-destroy-stage:
    name: Destroy Stage
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'stage' || github.event.inputs.environment == 'all'
    environment:
      name: stage-destroy
    
    steps:
      - name: Validate Destroy Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ Debes escribir 'DESTROY' para confirmar la destrucciÃ³n"
            exit 1
          fi
          echo "âœ… ConfirmaciÃ³n de destrucciÃ³n recibida para stage"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "âŒ Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "âŒ Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "âŒ Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "âŒ Error: AZURE_CLIENT_ID secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then
            echo "âŒ Error: AZURE_CLIENT_SECRET secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "âŒ Error: AZURE_SUBSCRIPTION_ID secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "âŒ Error: AZURE_TENANT_ID secret is missing"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=stage/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "âœ… Estado encontrado con recursos:"
            terraform state list
          else
            echo "âš ï¸ Estado vacÃ­o o no existe - no hay nada que destruir"
            echo "âœ… Saltando destroy (no hay recursos en el estado)"
            exit 0
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Destroy
        id: destroy
        run: |
          echo "ðŸ—‘ï¸ Iniciando destrucciÃ³n de infraestructura stage..."
          terraform destroy -auto-approve -var-file=environments/stage/terraform.tfvars
          DESTROY_EXIT_CODE=$?
          if [ "$DESTROY_EXIT_CODE" -eq 0 ]; then
            echo "âœ… DestrucciÃ³n completada exitosamente"
          else
            echo "âŒ Error durante la destrucciÃ³n (cÃ³digo: $DESTROY_EXIT_CODE)"
            exit $DESTROY_EXIT_CODE
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Destroy Summary
        run: |
          echo "## ðŸ—‘ï¸ Infraestructura Stage Destruida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Entorno:** stage" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY

  terraform-destroy-prod:
    name: Destroy Prod
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'all'
    environment:
      name: prod-destroy
    
    steps:
      - name: Validate Destroy Confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "âŒ Debes escribir 'DESTROY' para confirmar la destrucciÃ³n"
            exit 1
          fi
          echo "âœ… ConfirmaciÃ³n de destrucciÃ³n recibida para prod"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "âŒ Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "âŒ Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "âŒ Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "âŒ Error: AZURE_CLIENT_ID secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then
            echo "âŒ Error: AZURE_CLIENT_SECRET secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
            echo "âŒ Error: AZURE_SUBSCRIPTION_ID secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "âŒ Error: AZURE_TENANT_ID secret is missing"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "âœ… Estado encontrado con recursos:"
            terraform state list
          else
            echo "âš ï¸ Estado vacÃ­o o no existe - no hay nada que destruir"
            echo "âœ… Saltando destroy (no hay recursos en el estado)"
            exit 0
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Destroy
        id: destroy
        run: |
          echo "ðŸ—‘ï¸ Iniciando destrucciÃ³n de infraestructura prod..."
          terraform destroy -auto-approve -var-file=environments/prod/terraform.tfvars
          DESTROY_EXIT_CODE=$?
          if [ "$DESTROY_EXIT_CODE" -eq 0 ]; then
            echo "âœ… DestrucciÃ³n completada exitosamente"
          else
            echo "âŒ Error durante la destrucciÃ³n (cÃ³digo: $DESTROY_EXIT_CODE)"
            exit $DESTROY_EXIT_CODE
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Destroy Summary
        run: |
          echo "## ðŸ—‘ï¸ Infraestructura Prod Destruida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Entorno:** prod" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
