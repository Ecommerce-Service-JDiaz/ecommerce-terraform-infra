name: ðŸ” Deploy Key Vault

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'Forzar redespliegue completo'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths:
      - 'environments/global/**'
      - 'modules/azure/keyvault/**'
      - '.github/workflows/deploy-keyvault.yml'

env:
  TF_VERSION: '1.6.0'

jobs:
  deploy-keyvault:
    name: Deploy Key Vault Global
    runs-on: ubuntu-latest
    environment:
      name: global
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          REQUIRED_SECRETS=(
            "AZURE_STATE_RESOURCE_GROUP"
            "AZURE_STATE_STORAGE_ACCOUNT"
            "AZURE_STATE_CONTAINER"
            "AZURE_CLIENT_ID"
            "AZURE_CLIENT_SECRET"
            "AZURE_SUBSCRIPTION_ID"
            "AZURE_TENANT_ID"
            "RESOURCE_PREFIX"
            "AZURE_LOCATION"
            "AZURE_RESOURCE_GROUP_DEV"
            "AKS_CLUSTER_NAME_DEV"
            "AZURE_RESOURCE_GROUP_STAGE"
            "AKS_CLUSTER_NAME_STAGE"
            "AZURE_RESOURCE_GROUP_PROD"
            "AKS_CLUSTER_NAME_PROD"
            "DOCKERHUB_USERNAME"
            "DOCKERHUB_TOKEN"
            "SPRING_CLOUD_CONFIG_SERVER_GIT_URI"
            "SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL"
          )
          
          MISSING_SECRETS=()
          for secret in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${{ secrets[secret] }}" ]; then
              MISSING_SECRETS+=("$secret")
            fi
          done
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Service Principal Object ID
        id: sp_object_id
        run: |
          SP_OBJECT_ID=$(az ad sp show --id "$ARM_CLIENT_ID" --query id -o tsv)
          echo "object_id=$SP_OBJECT_ID" >> $GITHUB_OUTPUT
          echo "Service Principal Object ID: $SP_OBJECT_ID"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Init
        run: |
          cd environments/global
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=global/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        run: |
          cd environments/global
          terraform plan \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
            -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
            -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
            -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
            -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
            -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
            -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
            -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
            -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" \
            -out=tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Apply
        run: |
          cd environments/global
          if [ -f tfplan ]; then
            terraform apply -auto-approve tfplan
          else
            echo "â„¹ï¸ No hay cambios que aplicar"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Deployment Summary
        run: |
          echo "## âœ… Key Vault Global Desplegado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

