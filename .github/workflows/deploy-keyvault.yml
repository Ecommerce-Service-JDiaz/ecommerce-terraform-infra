name: Deploy Key Vault

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'Forzar redespliegue completo (recrea todos los recursos incluso si no hay cambios)'
        required: false
        type: boolean
        default: false

env:
  TF_VERSION: '1.6.0'

jobs:
  deploy-keyvault:
    name: Deploy Key Vault Global
    runs-on: ubuntu-latest
    environment:
      name: global
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then MISSING_SECRETS+=("AZURE_STATE_RESOURCE_GROUP"); fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then MISSING_SECRETS+=("AZURE_STATE_STORAGE_ACCOUNT"); fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then MISSING_SECRETS+=("AZURE_STATE_CONTAINER"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_ID"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_SECRET"); fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then MISSING_SECRETS+=("AZURE_SUBSCRIPTION_ID"); fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then MISSING_SECRETS+=("AZURE_TENANT_ID"); fi
          if [ -z "${{ secrets.RESOURCE_PREFIX }}" ]; then MISSING_SECRETS+=("RESOURCE_PREFIX"); fi
          if [ -z "${{ secrets.AZURE_LOCATION }}" ]; then MISSING_SECRETS+=("AZURE_LOCATION"); fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" ]; then MISSING_SECRETS+=("AZURE_RESOURCE_GROUP_DEV"); fi
          if [ -z "${{ secrets.AKS_CLUSTER_NAME_DEV }}" ]; then MISSING_SECRETS+=("AKS_CLUSTER_NAME_DEV"); fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" ]; then MISSING_SECRETS+=("AZURE_RESOURCE_GROUP_STAGE"); fi
          if [ -z "${{ secrets.AKS_CLUSTER_NAME_STAGE }}" ]; then MISSING_SECRETS+=("AKS_CLUSTER_NAME_STAGE"); fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" ]; then MISSING_SECRETS+=("AZURE_RESOURCE_GROUP_PROD"); fi
          if [ -z "${{ secrets.AKS_CLUSTER_NAME_PROD }}" ]; then MISSING_SECRETS+=("AKS_CLUSTER_NAME_PROD"); fi
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then MISSING_SECRETS+=("DOCKERHUB_USERNAME"); fi
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then MISSING_SECRETS+=("DOCKERHUB_TOKEN"); fi
          if [ -z "${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" ]; then MISSING_SECRETS+=("SPRING_CLOUD_CONFIG_SERVER_GIT_URI"); fi
          if [ -z "${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" ]; then MISSING_SECRETS+=("SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL"); fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Service Principal Object ID
        id: sp_object_id
        run: |
          SP_OBJECT_ID=$(az ad sp show --id "$ARM_CLIENT_ID" --query id -o tsv)
          echo "object_id=$SP_OBJECT_ID" >> $GITHUB_OUTPUT
          echo "Service Principal Object ID: $SP_OBJECT_ID"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Init
        run: |
          cd environments/global
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=global/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Import Existing Key Vault Resources (if exist)
        run: |
          cd environments/global
          echo "ðŸ” Verificando si el Key Vault y Resource Group ya existen..."
          
          # Calcular el nombre del Key Vault (mismo cÃ¡lculo que en el mÃ³dulo)
          RESOURCE_PREFIX_CLEAN=$(echo "${{ secrets.RESOURCE_PREFIX }}" | tr -d '-')
          HASH=$(echo -n "${{ secrets.RESOURCE_PREFIX }}global" | md5sum | cut -c1-4)
          KEY_VAULT_NAME="${RESOURCE_PREFIX_CLEAN}kv${HASH}"
          RESOURCE_GROUP_NAME="${{ secrets.RESOURCE_PREFIX }}-rg-global"
          
          # Verificar si el Resource Group existe
          if az group show --name "$RESOURCE_GROUP_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
            echo "âœ… Resource Group encontrado: $RESOURCE_GROUP_NAME"
            
            # Importar Resource Group si no estÃ¡ en el estado
            if ! terraform state show module.keyvault.azurerm_resource_group.global >/dev/null 2>&1; then
              echo "ðŸ“¥ Importando Resource Group al estado de Terraform..."
              RESOURCE_GROUP_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_NAME}"
              terraform import \
                -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
                -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
                -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
                -var="location=${{ secrets.AZURE_LOCATION }}" \
                -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
                -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
                -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
                -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
                -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
                -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
                -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
                -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
                -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
                -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
                -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" \
                module.keyvault.azurerm_resource_group.global \
                "$RESOURCE_GROUP_ID" || echo "âš ï¸ No se pudo importar el Resource Group"
            else
              echo "â„¹ï¸ El Resource Group ya estÃ¡ en el estado de Terraform"
            fi
            
            # Verificar si el Key Vault existe
            if az keyvault show --name "$KEY_VAULT_NAME" --resource-group "$RESOURCE_GROUP_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
              echo "âœ… Key Vault encontrado: $KEY_VAULT_NAME"
              
              # Importar Key Vault si no estÃ¡ en el estado
              if ! terraform state show module.keyvault.azurerm_key_vault.global >/dev/null 2>&1; then
                echo "ðŸ“¥ Importando Key Vault al estado de Terraform..."
                KEY_VAULT_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}"
                terraform import \
                  -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
                  -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
                  -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
                  -var="location=${{ secrets.AZURE_LOCATION }}" \
                  -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
                  -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
                  -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
                  -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
                  -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
                  -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
                  -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
                  -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
                  -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
                  -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
                  -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" \
                  module.keyvault.azurerm_key_vault.global \
                  "$KEY_VAULT_ID" || echo "âš ï¸ No se pudo importar el Key Vault"
              else
                echo "â„¹ï¸ El Key Vault ya estÃ¡ en el estado de Terraform"
              fi
            else
              echo "â„¹ï¸ El Key Vault no existe aÃºn (se crearÃ¡ en el plan)"
            fi
          else
            echo "â„¹ï¸ El Resource Group no existe aÃºn (se crearÃ¡ en el plan)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Import Existing Access Policy (if exists)
        run: |
          cd environments/global
          echo "ðŸ” Verificando si la polÃ­tica de acceso del Service Principal ya existe..."
          
          # Calcular el nombre del Key Vault (mismo cÃ¡lculo que en el mÃ³dulo)
          RESOURCE_PREFIX_CLEAN=$(echo "${{ secrets.RESOURCE_PREFIX }}" | tr -d '-')
          HASH=$(echo -n "${{ secrets.RESOURCE_PREFIX }}global" | md5sum | cut -c1-4)
          KEY_VAULT_NAME="${RESOURCE_PREFIX_CLEAN}kv${HASH}"
          
          KEY_VAULT_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ secrets.RESOURCE_PREFIX }}-rg-global/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}"
          SERVICE_PRINCIPAL_OBJECT_ID="${{ steps.sp_object_id.outputs.object_id }}"
          ACCESS_POLICY_ID="${KEY_VAULT_ID}/objectId/${SERVICE_PRINCIPAL_OBJECT_ID}"
          
          # Verificar si el Key Vault existe
          if az keyvault show --name "$KEY_VAULT_NAME" --resource-group "${{ secrets.RESOURCE_PREFIX }}-rg-global" --query id -o tsv 2>/dev/null | grep -q .; then
            echo "âœ… Key Vault encontrado: $KEY_VAULT_NAME"
            
            # Verificar si la polÃ­tica de acceso existe
            if az keyvault show --name "$KEY_VAULT_NAME" --query "properties.accessPolicies[?objectId=='${SERVICE_PRINCIPAL_OBJECT_ID}']" -o json 2>/dev/null | grep -q "objectId"; then
              echo "âœ… PolÃ­tica de acceso encontrada para el Service Principal"
              
              # Intentar importar al estado de Terraform
              if ! terraform state show module.keyvault.azurerm_key_vault_access_policy.service_principal >/dev/null 2>&1; then
                echo "ðŸ“¥ Importando polÃ­tica de acceso existente al estado de Terraform..."
                terraform import \
                  -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
                  -var="service_principal_object_id=${SERVICE_PRINCIPAL_OBJECT_ID}" \
                  -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
                  -var="location=${{ secrets.AZURE_LOCATION }}" \
                  -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
                  -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
                  -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
                  -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
                  -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
                  -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
                  -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
                  -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
                  -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
                  -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
                  -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" \
                  module.keyvault.azurerm_key_vault_access_policy.service_principal \
                  "$ACCESS_POLICY_ID" || echo "âš ï¸ No se pudo importar (puede que ya estÃ© en el estado o necesite actualizaciÃ³n)"
              else
                echo "â„¹ï¸ La polÃ­tica de acceso ya estÃ¡ en el estado de Terraform"
              fi
            else
              echo "â„¹ï¸ La polÃ­tica de acceso no existe aÃºn (se crearÃ¡ en el plan)"
            fi
          else
            echo "â„¹ï¸ El Key Vault no existe aÃºn (se crearÃ¡ en el plan)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Plan
        run: |
          cd environments/global
          terraform plan \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
            -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
            -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
            -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
            -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
            -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
            -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
            -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
            -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" \
            -out=tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Force Unlock State (if locked)
        run: |
          cd environments/global
          echo "ðŸ”“ Verificando si el estado estÃ¡ bloqueado..."
          set +e
          terraform plan \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -lock=false 2>&1 | tee unlock_check.txt
          set -e
          
          if grep -q "state blob is already locked" unlock_check.txt; then
            echo "âš ï¸ Estado bloqueado detectado, extrayendo Lock ID..."
            LOCK_ID=$(grep -oP 'ID:\s+\K[a-f0-9-]+' unlock_check.txt | head -1 || echo "")
            if [ -n "$LOCK_ID" ]; then
              echo "ðŸ”“ Liberando lock: $LOCK_ID"
              terraform force-unlock -force "$LOCK_ID" || echo "âš ï¸ No se pudo liberar el lock (puede que ya estÃ© liberado)"
            fi
          fi
          rm -f unlock_check.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Apply
        run: |
          cd environments/global
          if [ -f tfplan ]; then
            set +e
            terraform apply -auto-approve tfplan 2>&1 | tee apply_output.txt
            APPLY_EXIT_CODE=${PIPESTATUS[0]}
            set -e
            
            if [ "$APPLY_EXIT_CODE" -ne 0 ]; then
              if grep -q "state blob is already locked" apply_output.txt; then
                echo "âš ï¸ Estado aÃºn bloqueado, extrayendo Lock ID y liberando..."
                LOCK_ID=$(grep -oP 'ID:\s+\K[a-f0-9-]+' apply_output.txt | head -1 || echo "")
                if [ -n "$LOCK_ID" ]; then
                  echo "ðŸ”“ Liberando lock: $LOCK_ID"
                  terraform force-unlock -force "$LOCK_ID"
                  echo "ðŸ”„ Reintentando apply..."
                  terraform apply -auto-approve tfplan
                else
                  echo "âŒ No se pudo extraer el Lock ID"
                  cat apply_output.txt
                  exit 1
                fi
              else
                echo "âŒ Error durante el apply"
                cat apply_output.txt
                exit $APPLY_EXIT_CODE
              fi
            fi
            rm -f apply_output.txt
          else
            echo "â„¹ï¸ No hay cambios que aplicar"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Saved to Backend
        run: |
          echo "ðŸ” Verificando que el estado se guardÃ³ en Azure Storage..."
          STATE_KEY="global/terraform.tfstate"
          echo "ðŸ“ Ruta del estado: $STATE_KEY"
          
          # Verificar que el blob existe en el storage
          if az storage blob exists \
            --account-name "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            --container-name "${{ secrets.AZURE_STATE_CONTAINER }}" \
            --name "$STATE_KEY" \
            --auth-mode login \
            --query exists -o tsv 2>/dev/null | grep -q "true"; then
            echo "âœ… Estado verificado - se guardÃ³ en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/$STATE_KEY"
            
            # Obtener informaciÃ³n del blob
            BLOB_INFO=$(az storage blob show \
              --account-name "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
              --container-name "${{ secrets.AZURE_STATE_CONTAINER }}" \
              --name "$STATE_KEY" \
              --auth-mode login \
              --query "{size:properties.contentLength,lastModified:properties.lastModified}" -o json 2>/dev/null || echo "{}")
            
            if [ "$BLOB_INFO" != "{}" ]; then
              echo "ðŸ“Š InformaciÃ³n del estado:"
              echo "$BLOB_INFO" | jq -r '"TamaÃ±o: " + (.size | tostring) + " bytes, Ãšltima modificaciÃ³n: " + .lastModified'
            fi
          else
            echo "âš ï¸ No se pudo verificar el blob en Azure Storage (puede ser normal si es la primera ejecuciÃ³n)"
            echo "ðŸ“‹ Listando estados disponibles en el storage:"
            az storage blob list \
              --account-name "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
              --container-name "${{ secrets.AZURE_STATE_CONTAINER }}" \
              --auth-mode login \
              --query "[].name" -o tsv 2>/dev/null | head -10 || echo "No se pudieron listar los blobs"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Get Key Vault Name
        id: kv_name
        run: |
          cd environments/global
          KEY_VAULT_NAME=$(terraform output -raw key_vault_name 2>/dev/null || echo "")
          if [ -z "$KEY_VAULT_NAME" ]; then
            echo "âš ï¸ No se pudo obtener el nombre del Key Vault desde outputs"
            exit 0
          fi
          echo "key_vault_name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "Key Vault Name: $KEY_VAULT_NAME"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: List Key Vault Secrets
        id: list_secrets
        run: |
          if [ -n "${{ steps.kv_name.outputs.key_vault_name }}" ]; then
            echo "ðŸ“‹ Listando secrets creados en el Key Vault..."
            SECRETS=$(az keyvault secret list --vault-name "${{ steps.kv_name.outputs.key_vault_name }}" --query "[].name" -o tsv 2>/dev/null || echo "")
            if [ -n "$SECRETS" ]; then
              echo "$SECRETS" | while read secret; do
                echo "  - $secret"
              done
              echo "$SECRETS" > secrets_list.txt
            else
              echo "âš ï¸ No se encontraron secrets en el Key Vault"
            fi
          else
            echo "âš ï¸ No se pudo obtener el nombre del Key Vault"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Deployment Summary
        run: |
          echo "## âœ… Key Vault Global Desplegado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Estado guardado en:** \`${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/global/terraform.tfstate\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.kv_name.outputs.key_vault_name }}" ]; then
            echo "**Key Vault:** ${{ steps.kv_name.outputs.key_vault_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Secrets Creados en el Key Vault:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f secrets_list.txt ] && [ -s secrets_list.txt ]; then
              while read secret; do
                echo "- \`$secret\`" >> $GITHUB_STEP_SUMMARY
              done < secrets_list.txt
            else
              echo "- AZURE-RESOURCE-GROUP-DEV" >> $GITHUB_STEP_SUMMARY
              echo "- AKS-CLUSTER-NAME-DEV" >> $GITHUB_STEP_SUMMARY
              echo "- AZURE-RESOURCE-GROUP-STAGE" >> $GITHUB_STEP_SUMMARY
              echo "- AKS-CLUSTER-NAME-STAGE" >> $GITHUB_STEP_SUMMARY
              echo "- AZURE-RESOURCE-GROUP-PROD" >> $GITHUB_STEP_SUMMARY
              echo "- AKS-CLUSTER-NAME-PROD" >> $GITHUB_STEP_SUMMARY
              echo "- DOCKERHUB-USERNAME" >> $GITHUB_STEP_SUMMARY
              echo "- DOCKERHUB-TOKEN" >> $GITHUB_STEP_SUMMARY
              echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-URI" >> $GITHUB_STEP_SUMMARY
              echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-DEFAULT-LABEL" >> $GITHUB_STEP_SUMMARY
              if [ -n "${{ secrets.AZURE_CREDENTIAL }}" ]; then
                echo "- AZURE-CREDENTIAL" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "### ðŸ“‹ Secrets Creados en el Key Vault:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- AZURE-RESOURCE-GROUP-DEV" >> $GITHUB_STEP_SUMMARY
            echo "- AKS-CLUSTER-NAME-DEV" >> $GITHUB_STEP_SUMMARY
            echo "- AZURE-RESOURCE-GROUP-STAGE" >> $GITHUB_STEP_SUMMARY
            echo "- AKS-CLUSTER-NAME-STAGE" >> $GITHUB_STEP_SUMMARY
            echo "- AZURE-RESOURCE-GROUP-PROD" >> $GITHUB_STEP_SUMMARY
            echo "- AKS-CLUSTER-NAME-PROD" >> $GITHUB_STEP_SUMMARY
            echo "- DOCKERHUB-USERNAME" >> $GITHUB_STEP_SUMMARY
            echo "- DOCKERHUB-TOKEN" >> $GITHUB_STEP_SUMMARY
            echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-URI" >> $GITHUB_STEP_SUMMARY
            echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-DEFAULT-LABEL" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ secrets.AZURE_CREDENTIAL }}" ]; then
              echo "- AZURE-CREDENTIAL" >> $GITHUB_STEP_SUMMARY
            fi
          fi

