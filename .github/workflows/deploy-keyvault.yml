name: Deploy Key Vault

on:
  workflow_dispatch:
    inputs:
      force_redeploy:
        description: 'Forzar redespliegue completo (recrea todos los recursos incluso si no hay cambios)'
        required: false
        type: boolean
        default: false

env:
  TF_VERSION: '1.6.0'

jobs:
  deploy-keyvault:
    name: Deploy Key Vault Global
    runs-on: ubuntu-latest
    environment:
      name: global
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then MISSING_SECRETS+=("AZURE_STATE_RESOURCE_GROUP"); fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then MISSING_SECRETS+=("AZURE_STATE_STORAGE_ACCOUNT"); fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then MISSING_SECRETS+=("AZURE_STATE_CONTAINER"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_ID"); fi
          if [ -z "${{ secrets.AZURE_CLIENT_SECRET }}" ]; then MISSING_SECRETS+=("AZURE_CLIENT_SECRET"); fi
          if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then MISSING_SECRETS+=("AZURE_SUBSCRIPTION_ID"); fi
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then MISSING_SECRETS+=("AZURE_TENANT_ID"); fi
          if [ -z "${{ secrets.RESOURCE_PREFIX }}" ]; then MISSING_SECRETS+=("RESOURCE_PREFIX"); fi
          if [ -z "${{ secrets.AZURE_LOCATION }}" ]; then MISSING_SECRETS+=("AZURE_LOCATION"); fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" ]; then MISSING_SECRETS+=("AZURE_RESOURCE_GROUP_DEV"); fi
          if [ -z "${{ secrets.AKS_CLUSTER_NAME_DEV }}" ]; then MISSING_SECRETS+=("AKS_CLUSTER_NAME_DEV"); fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" ]; then MISSING_SECRETS+=("AZURE_RESOURCE_GROUP_STAGE"); fi
          if [ -z "${{ secrets.AKS_CLUSTER_NAME_STAGE }}" ]; then MISSING_SECRETS+=("AKS_CLUSTER_NAME_STAGE"); fi
          if [ -z "${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" ]; then MISSING_SECRETS+=("AZURE_RESOURCE_GROUP_PROD"); fi
          if [ -z "${{ secrets.AKS_CLUSTER_NAME_PROD }}" ]; then MISSING_SECRETS+=("AKS_CLUSTER_NAME_PROD"); fi
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then MISSING_SECRETS+=("DOCKERHUB_USERNAME"); fi
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then MISSING_SECRETS+=("DOCKERHUB_TOKEN"); fi
          if [ -z "${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" ]; then MISSING_SECRETS+=("SPRING_CLOUD_CONFIG_SERVER_GIT_URI"); fi
          if [ -z "${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" ]; then MISSING_SECRETS+=("SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL"); fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Error: Missing required secrets:"
            printf '  - %s\n' "${MISSING_SECRETS[@]}"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Service Principal Object ID
        id: sp_object_id
        run: |
          SP_OBJECT_ID=$(az ad sp show --id "$ARM_CLIENT_ID" --query id -o tsv)
          echo "object_id=$SP_OBJECT_ID" >> $GITHUB_OUTPUT
          echo "Service Principal Object ID: $SP_OBJECT_ID"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Init
        run: |
          cd environments/global
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=global/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        run: |
          cd environments/global
          terraform plan \
            -var="tenant_id=${{ secrets.AZURE_TENANT_ID }}" \
            -var="service_principal_object_id=${{ steps.sp_object_id.outputs.object_id }}" \
            -var="resource_prefix=${{ secrets.RESOURCE_PREFIX }}" \
            -var="location=${{ secrets.AZURE_LOCATION }}" \
            -var="azure_resource_group_dev=${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" \
            -var="aks_cluster_name_dev=${{ secrets.AKS_CLUSTER_NAME_DEV }}" \
            -var="azure_resource_group_stage=${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" \
            -var="aks_cluster_name_stage=${{ secrets.AKS_CLUSTER_NAME_STAGE }}" \
            -var="azure_resource_group_prod=${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" \
            -var="aks_cluster_name_prod=${{ secrets.AKS_CLUSTER_NAME_PROD }}" \
            -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
            -var="dockerhub_token=${{ secrets.DOCKERHUB_TOKEN }}" \
            -var="azure_credential=${{ secrets.AZURE_CREDENTIAL }}" \
            -var="spring_cloud_config_server_git_uri=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_URI }}" \
            -var="spring_cloud_config_server_git_default_label=${{ secrets.SPRING_CLOUD_CONFIG_SERVER_GIT_DEFAULT_LABEL }}" \
            -out=tfplan
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Apply
        run: |
          cd environments/global
          if [ -f tfplan ]; then
            terraform apply -auto-approve tfplan
          else
            echo "â„¹ï¸ No hay cambios que aplicar"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Key Vault Name
        id: kv_name
        run: |
          cd environments/global
          KEY_VAULT_NAME=$(terraform output -raw key_vault_name 2>/dev/null || echo "")
          if [ -z "$KEY_VAULT_NAME" ]; then
            echo "âš ï¸ No se pudo obtener el nombre del Key Vault desde outputs"
            exit 0
          fi
          echo "key_vault_name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "Key Vault Name: $KEY_VAULT_NAME"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: List Key Vault Secrets
        id: list_secrets
        run: |
          if [ -n "${{ steps.kv_name.outputs.key_vault_name }}" ]; then
            echo "ðŸ“‹ Listando secrets creados en el Key Vault..."
            SECRETS=$(az keyvault secret list --vault-name "${{ steps.kv_name.outputs.key_vault_name }}" --query "[].name" -o tsv 2>/dev/null || echo "")
            if [ -n "$SECRETS" ]; then
              echo "$SECRETS" | while read secret; do
                echo "  - $secret"
              done
              echo "$SECRETS" > secrets_list.txt
            else
              echo "âš ï¸ No se encontraron secrets en el Key Vault"
            fi
          else
            echo "âš ï¸ No se pudo obtener el nombre del Key Vault"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Deployment Summary
        run: |
          echo "## âœ… Key Vault Global Desplegado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ejecutado por:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fecha:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.kv_name.outputs.key_vault_name }}" ]; then
            echo "**Key Vault:** ${{ steps.kv_name.outputs.key_vault_name }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Secrets Creados en el Key Vault:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -f secrets_list.txt ] && [ -s secrets_list.txt ]; then
              while read secret; do
                echo "- \`$secret\`" >> $GITHUB_STEP_SUMMARY
              done < secrets_list.txt
            else
              echo "- AZURE-RESOURCE-GROUP-DEV" >> $GITHUB_STEP_SUMMARY
              echo "- AKS-CLUSTER-NAME-DEV" >> $GITHUB_STEP_SUMMARY
              echo "- AZURE-RESOURCE-GROUP-STAGE" >> $GITHUB_STEP_SUMMARY
              echo "- AKS-CLUSTER-NAME-STAGE" >> $GITHUB_STEP_SUMMARY
              echo "- AZURE-RESOURCE-GROUP-PROD" >> $GITHUB_STEP_SUMMARY
              echo "- AKS-CLUSTER-NAME-PROD" >> $GITHUB_STEP_SUMMARY
              echo "- DOCKERHUB-USERNAME" >> $GITHUB_STEP_SUMMARY
              echo "- DOCKERHUB-TOKEN" >> $GITHUB_STEP_SUMMARY
              echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-URI" >> $GITHUB_STEP_SUMMARY
              echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-DEFAULT-LABEL" >> $GITHUB_STEP_SUMMARY
              if [ -n "${{ secrets.AZURE_CREDENTIAL }}" ]; then
                echo "- AZURE-CREDENTIAL" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "### ðŸ“‹ Secrets Creados en el Key Vault:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- AZURE-RESOURCE-GROUP-DEV" >> $GITHUB_STEP_SUMMARY
            echo "- AKS-CLUSTER-NAME-DEV" >> $GITHUB_STEP_SUMMARY
            echo "- AZURE-RESOURCE-GROUP-STAGE" >> $GITHUB_STEP_SUMMARY
            echo "- AKS-CLUSTER-NAME-STAGE" >> $GITHUB_STEP_SUMMARY
            echo "- AZURE-RESOURCE-GROUP-PROD" >> $GITHUB_STEP_SUMMARY
            echo "- AKS-CLUSTER-NAME-PROD" >> $GITHUB_STEP_SUMMARY
            echo "- DOCKERHUB-USERNAME" >> $GITHUB_STEP_SUMMARY
            echo "- DOCKERHUB-TOKEN" >> $GITHUB_STEP_SUMMARY
            echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-URI" >> $GITHUB_STEP_SUMMARY
            echo "- SPRING-CLOUD-CONFIG-SERVER-GIT-DEFAULT-LABEL" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ secrets.AZURE_CREDENTIAL }}" ]; then
              echo "- AZURE-CREDENTIAL" >> $GITHUB_STEP_SUMMARY
            fi
          fi

