name: Deploy Infrastructure

on:
  pull_request:
    branches:
      - main
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a desplegar'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod

env:
  TF_VERSION: '1.6.0'
  AZURE_CLI_VERSION: '2.0'

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          ENV=$(echo "${{ github.head_ref }}" | grep -oE '(dev|stage|prod)' || echo "dev")
          terraform plan -var-file=environments/$ENV/terraform.tfvars -no-color
        continue-on-error: true
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`\n
            ${process.env.PLAN}
            \`\`\`
            
            </details>
            
            *Pusheado por: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  create-keyvault:
    name: Create Global Key Vault
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: global
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "‚ùå Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=global/terraform.tfstate" \
            -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          terraform plan -var-file=environments/global/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt
          PLAN_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ "$PLAN_EXIT_CODE" = "1" ]; then
            echo "‚ùå Error en el plan"
            cat plan_output.txt
            exit 1
          elif [ "$PLAN_EXIT_CODE" = "2" ]; then
            echo "‚úÖ Plan exitoso - hay cambios que aplicar"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Plan exitoso - no hay cambios"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            rm -f tfplan
          fi
          set -e
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Apply
        run: |
          if [ -f tfplan ]; then
            echo "üöÄ Aplicando cambios de Terraform..."
            terraform apply -auto-approve tfplan
            APPLY_EXIT_CODE=$?
            if [ "$APPLY_EXIT_CODE" -eq 0 ]; then
              echo "‚úÖ Cambios aplicados exitosamente"
            else
              echo "‚ùå Error al aplicar cambios (c√≥digo: $APPLY_EXIT_CODE)"
              exit $APPLY_EXIT_CODE
            fi
          else
            echo "‚ÑπÔ∏è No hay cambios que aplicar - saltando apply"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Get Key Vault Name
        id: keyvault
        run: |
          KEY_VAULT_NAME=$(terraform output -raw key_vault_name 2>/dev/null || echo "")
          if [ -z "$KEY_VAULT_NAME" ]; then
            # Si no hay output, construir el nombre usando la misma l√≥gica que en keyvault.tf
            RESOURCE_PREFIX="ecommerce"
            KEY_VAULT_NAME="${RESOURCE_PREFIX}kv$(echo -n "${RESOURCE_PREFIX}global" | md5sum | cut -c1-8)"
          fi
          echo "key_vault_name=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Key Vault Name: $KEY_VAULT_NAME"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Insert Secrets to Key Vault
        run: |
          KEY_VAULT_NAME="${{ steps.keyvault.outputs.key_vault_name }}"
          echo "üîê Insertando secretos en Key Vault: $KEY_VAULT_NAME"
          
          # Verificar que el Key Vault existe
          if ! az keyvault show --name "$KEY_VAULT_NAME" --output none 2>/dev/null; then
            echo "‚ùå Key Vault no encontrado: $KEY_VAULT_NAME"
            exit 1
          fi
          
          # Insertar secretos desde GitHub Secrets
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "AZURE-RESOURCE-GROUP-DEV" --value "${{ secrets.AZURE_RESOURCE_GROUP_DEV }}" || echo "‚ö†Ô∏è Error al insertar AZURE-RESOURCE-GROUP-DEV"
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "AKS-CLUSTER-NAME-DEV" --value "${{ secrets.AKS_CLUSTER_NAME_DEV }}" || echo "‚ö†Ô∏è Error al insertar AKS-CLUSTER-NAME-DEV"
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "AZURE-RESOURCE-GROUP-STAGE" --value "${{ secrets.AZURE_RESOURCE_GROUP_STAGE }}" || echo "‚ö†Ô∏è Error al insertar AZURE-RESOURCE-GROUP-STAGE"
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "AKS-CLUSTER-NAME-STAGE" --value "${{ secrets.AKS_CLUSTER_NAME_STAGE }}" || echo "‚ö†Ô∏è Error al insertar AKS-CLUSTER-NAME-STAGE"
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "AZURE-RESOURCE-GROUP-PROD" --value "${{ secrets.AZURE_RESOURCE_GROUP_PROD }}" || echo "‚ö†Ô∏è Error al insertar AZURE-RESOURCE-GROUP-PROD"
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "AKS-CLUSTER-NAME-PROD" --value "${{ secrets.AKS_CLUSTER_NAME_PROD }}" || echo "‚ö†Ô∏è Error al insertar AKS-CLUSTER-NAME-PROD"
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "DOCKERHUB-USERNAME" --value "${{ secrets.DOCKERHUB_USERNAME }}" || echo "‚ö†Ô∏è Error al insertar DOCKERHUB-USERNAME"
          az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "DOCKERHUB-TOKEN" --value "${{ secrets.DOCKERHUB_TOKEN }}" || echo "‚ö†Ô∏è Error al insertar DOCKERHUB-TOKEN"
          
          if [ -n "${{ secrets.AZURE_CREDENTIAL }}" ]; then
            az keyvault secret set --vault-name "$KEY_VAULT_NAME" --name "AZURE-CREDENTIAL" --value "${{ secrets.AZURE_CREDENTIAL }}" || echo "‚ö†Ô∏è Error al insertar AZURE-CREDENTIAL"
          fi
          
          echo "‚úÖ Secretos insertados en Key Vault"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  terraform-apply-dev:
    name: Deploy Dev
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "‚ùå Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "‚ùå Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "‚ùå Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          echo "üîß Inicializando Terraform con backend remoto..."
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=dev/terraform.tfstate" \
            -reconfigure
          echo "‚úÖ Terraform inicializado"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify Backend Configuration
        run: |
          echo "üîç Verificando configuraci√≥n del backend..."
          if [ -f .terraform/terraform.tfstate ]; then
            echo "‚úÖ Backend configurado correctamente"
            echo "üìã Informaci√≥n del backend:"
            cat .terraform/terraform.tfstate | grep -A 10 "backend" || echo "Backend configurado (detalles en logs de init)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ archivo de estado del backend"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "‚úÖ Estado encontrado con recursos existentes"
            terraform state list
          else
            echo "‚ÑπÔ∏è Estado vac√≠o o no existe (primera ejecuci√≥n)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -var-file=environments/dev/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
          if [ "$PLAN_EXIT_CODE" = "1" ]; then
            if grep -q "already exists" plan_output.txt; then
              echo "‚ö†Ô∏è Detectados recursos existentes que no est√°n en el estado"
              echo "üîÑ Intentando importar recursos existentes..."
              
              # Importar Resource Group si existe
              RG_NAME="ecommerce-rg-dev"
              if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado o error al importar"
              fi
              
              echo "üîÑ Re-ejecutando plan despu√©s de importar..."
              terraform plan -var-file=environments/dev/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
              if [ "$PLAN_EXIT_CODE" = "1" ] && grep -q "already exists" plan_output.txt; then
                echo "‚ÑπÔ∏è Algunos recursos a√∫n existen pero no se pueden importar autom√°ticamente"
                echo "‚úÖ Continuando sin cambios (los recursos ya est√°n desplegados)"
                rm -f tfplan
                PLAN_EXIT_CODE=0
              fi
            else
              echo "‚ùå Error en el plan que no es por recursos existentes"
              cat plan_output.txt
              exit 1
            fi
          elif [ "$PLAN_EXIT_CODE" = "2" ]; then
            echo "‚úÖ Plan exitoso - hay cambios que aplicar"
          else
            echo "‚úÖ Plan exitoso - no hay cambios (la infraestructura est√° actualizada)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Verify Plan File
        run: |
          if [ ! -f tfplan ]; then
            echo "‚ÑπÔ∏è No hay cambios que aplicar - la infraestructura ya est√° desplegada y actualizada"
            echo "‚úÖ Saltando apply (no se requiere acci√≥n)"
            exit 0
          fi
          echo "‚úÖ Plan file creado - hay cambios que aplicar"

      - name: Terraform Apply
        id: apply
        run: |
          if [ -f tfplan ]; then
            echo "üöÄ Aplicando cambios de Terraform..."
            terraform apply -auto-approve tfplan
            APPLY_EXIT_CODE=$?
            if [ "$APPLY_EXIT_CODE" -eq 0 ]; then
              echo "‚úÖ Cambios aplicados exitosamente"
            else
              echo "‚ùå Error al aplicar cambios (c√≥digo: $APPLY_EXIT_CODE)"
              exit $APPLY_EXIT_CODE
            fi
          else
            echo "‚ÑπÔ∏è No hay cambios que aplicar - saltando apply"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Saved to Backend
        run: |
          echo "üîç Verificando que el estado se guard√≥ en el backend remoto..."
          echo "üìã Listando recursos en el estado:"
          terraform state list
          echo ""
          echo "‚úÖ Estado verificado - se guard√≥ en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/dev/terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Output
        id: output
        run: terraform output -json
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  terraform-apply-stage:
    name: Deploy Stage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'stage')
    environment:
      name: stage
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "‚ùå Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "‚ùå Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "‚ùå Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          echo "üîß Inicializando Terraform con backend remoto..."
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=stage/terraform.tfstate" \
            -reconfigure
          echo "‚úÖ Terraform inicializado"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify Backend Configuration
        run: |
          echo "üîç Verificando configuraci√≥n del backend..."
          if [ -f .terraform/terraform.tfstate ]; then
            echo "‚úÖ Backend configurado correctamente"
            echo "üìã Informaci√≥n del backend:"
            cat .terraform/terraform.tfstate | grep -A 10 "backend" || echo "Backend configurado (detalles en logs de init)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ archivo de estado del backend"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "‚úÖ Estado encontrado con recursos existentes"
            terraform state list
          else
            echo "‚ÑπÔ∏è Estado vac√≠o o no existe (primera ejecuci√≥n)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -var-file=environments/stage/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
          if [ "$PLAN_EXIT_CODE" = "1" ]; then
            if grep -q "already exists" plan_output.txt; then
              echo "‚ö†Ô∏è Detectados recursos existentes que no est√°n en el estado"
              echo "üîÑ Intentando importar recursos existentes..."
              
              # Importar Resource Group si existe
              RG_NAME="ecommerce-rg-stage"
              if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado o error al importar"
              fi
              
              echo "üîÑ Re-ejecutando plan despu√©s de importar..."
              terraform plan -var-file=environments/stage/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
              if [ "$PLAN_EXIT_CODE" = "1" ] && grep -q "already exists" plan_output.txt; then
                echo "‚ÑπÔ∏è Algunos recursos a√∫n existen pero no se pueden importar autom√°ticamente"
                echo "‚úÖ Continuando sin cambios (los recursos ya est√°n desplegados)"
                rm -f tfplan
                PLAN_EXIT_CODE=0
              fi
            else
              echo "‚ùå Error en el plan que no es por recursos existentes"
              cat plan_output.txt
              exit 1
            fi
          elif [ "$PLAN_EXIT_CODE" = "2" ]; then
            echo "‚úÖ Plan exitoso - hay cambios que aplicar"
          else
            echo "‚úÖ Plan exitoso - no hay cambios (la infraestructura est√° actualizada)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Verify Plan File
        run: |
          if [ ! -f tfplan ]; then
            echo "‚ÑπÔ∏è No hay cambios que aplicar - la infraestructura ya est√° desplegada y actualizada"
            echo "‚úÖ Saltando apply (no se requiere acci√≥n)"
            exit 0
          fi
          echo "‚úÖ Plan file creado - hay cambios que aplicar"

      - name: Terraform Apply
        id: apply
        run: |
          if [ -f tfplan ]; then
            echo "üöÄ Aplicando cambios de Terraform..."
            terraform apply -auto-approve tfplan
            APPLY_EXIT_CODE=$?
            if [ "$APPLY_EXIT_CODE" -eq 0 ]; then
              echo "‚úÖ Cambios aplicados exitosamente"
            else
              echo "‚ùå Error al aplicar cambios (c√≥digo: $APPLY_EXIT_CODE)"
              exit $APPLY_EXIT_CODE
            fi
          else
            echo "‚ÑπÔ∏è No hay cambios que aplicar - saltando apply"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Saved to Backend
        run: |
          echo "üîç Verificando que el estado se guard√≥ en el backend remoto..."
          echo "üìã Listando recursos en el estado:"
          terraform state list
          echo ""
          echo "‚úÖ Estado verificado - se guard√≥ en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/stage/terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Output
        id: output
        run: terraform output -json
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  terraform-apply-prod:
    name: Deploy Prod
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment:
      name: prod
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "‚ùå Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "‚ùå Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "‚ùå Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          echo "üîß Inicializando Terraform con backend remoto..."
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -reconfigure
          echo "‚úÖ Terraform inicializado"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify Backend Configuration
        run: |
          echo "üîç Verificando configuraci√≥n del backend..."
          if [ -f .terraform/terraform.tfstate ]; then
            echo "‚úÖ Backend configurado correctamente"
            echo "üìã Informaci√≥n del backend:"
            cat .terraform/terraform.tfstate | grep -A 10 "backend" || echo "Backend configurado (detalles en logs de init)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ archivo de estado del backend"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "‚úÖ Estado encontrado con recursos existentes"
            terraform state list
          else
            echo "‚ÑπÔ∏è Estado vac√≠o o no existe (primera ejecuci√≥n)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -var-file=environments/prod/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
          if [ "$PLAN_EXIT_CODE" = "1" ]; then
            if grep -q "already exists" plan_output.txt; then
              echo "‚ö†Ô∏è Detectados recursos existentes que no est√°n en el estado"
              echo "üîÑ Intentando importar recursos existentes..."
              
              # Importar Resource Group si existe
              RG_NAME="ecommerce-rg-prod"
              if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado o error al importar"
              fi
              
              echo "üîÑ Re-ejecutando plan despu√©s de importar..."
              terraform plan -var-file=environments/prod/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
              if [ "$PLAN_EXIT_CODE" = "1" ] && grep -q "already exists" plan_output.txt; then
                echo "‚ÑπÔ∏è Algunos recursos a√∫n existen pero no se pueden importar autom√°ticamente"
                echo "‚úÖ Continuando sin cambios (los recursos ya est√°n desplegados)"
                rm -f tfplan
                PLAN_EXIT_CODE=0
              fi
            else
              echo "‚ùå Error en el plan que no es por recursos existentes"
              cat plan_output.txt
              exit 1
            fi
          elif [ "$PLAN_EXIT_CODE" = "2" ]; then
            echo "‚úÖ Plan exitoso - hay cambios que aplicar"
          else
            echo "‚úÖ Plan exitoso - no hay cambios (la infraestructura est√° actualizada)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Verify Plan File
        run: |
          if [ ! -f tfplan ]; then
            echo "‚ÑπÔ∏è No hay cambios que aplicar - la infraestructura ya est√° desplegada y actualizada"
            echo "‚úÖ Saltando apply (no se requiere acci√≥n)"
            exit 0
          fi
          echo "‚úÖ Plan file creado - hay cambios que aplicar"

      - name: Terraform Apply
        id: apply
        run: |
          if [ -f tfplan ]; then
            echo "üöÄ Aplicando cambios de Terraform..."
            terraform apply -auto-approve tfplan
            APPLY_EXIT_CODE=$?
            if [ "$APPLY_EXIT_CODE" -eq 0 ]; then
              echo "‚úÖ Cambios aplicados exitosamente"
            else
              echo "‚ùå Error al aplicar cambios (c√≥digo: $APPLY_EXIT_CODE)"
              exit $APPLY_EXIT_CODE
            fi
          else
            echo "‚ÑπÔ∏è No hay cambios que aplicar - saltando apply"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Saved to Backend
        run: |
          echo "üîç Verificando que el estado se guard√≥ en el backend remoto..."
          echo "üìã Listando recursos en el estado:"
          terraform state list
          echo ""
          echo "‚úÖ Estado verificado - se guard√≥ en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/prod/terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Output
        id: output
        run: terraform output -json
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
