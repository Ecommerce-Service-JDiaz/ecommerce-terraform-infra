name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - '**/*.tf'
      - '**/*.tfvars'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a desplegar'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod

env:
  TF_VERSION: '1.6.0'
  AZURE_CLI_VERSION: '2.0'

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          ENV=$(echo "${{ github.head_ref }}" | grep -oE '(dev|stage|prod)' || echo "dev")
          terraform plan -var-file=environments/$ENV/terraform.tfvars -no-color
        continue-on-error: true
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`\n
            ${process.env.PLAN}
            \`\`\`
            
            </details>
            
            *Pusheado por: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  terraform-apply-dev:
    name: Deploy Dev
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "‚ùå Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "‚ùå Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "‚ùå Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          echo "üîß Inicializando Terraform con backend remoto..."
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=dev/terraform.tfstate" \
            -reconfigure
          echo "‚úÖ Terraform inicializado"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify Backend Configuration
        run: |
          echo "üîç Verificando configuraci√≥n del backend..."
          if [ -f .terraform/terraform.tfstate ]; then
            echo "‚úÖ Backend configurado correctamente"
            echo "üìã Informaci√≥n del backend:"
            cat .terraform/terraform.tfstate | grep -A 10 "backend" || echo "Backend configurado (detalles en logs de init)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ archivo de estado del backend"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "‚úÖ Estado encontrado con recursos existentes"
            terraform state list
          else
            echo "‚ÑπÔ∏è Estado vac√≠o o no existe (primera ejecuci√≥n)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -var-file=environments/dev/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
          if [ "$PLAN_EXIT_CODE" = "1" ]; then
            if grep -q "already exists" plan_output.txt; then
              echo "‚ö†Ô∏è Detectados recursos existentes que no est√°n en el estado"
              echo "üîÑ Intentando importar recursos existentes..."
              
              ENV="dev"
              RG_NAME="ecommerce-rg-${ENV}"
              VNET_NAME="ecommerce-vnet-${ENV}"
              SUBNET_AKS_NAME="ecommerce-subnet-aks-${ENV}"
              SUBNET_NODES_NAME="ecommerce-subnet-nodes-${ENV}"
              AKS_CLUSTER_NAME="aks-cluster-${ENV}"
              
              # Importar Resource Group
              if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "üì¶ Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado"
              fi
              
              # Importar Virtual Network
              VNET_ID=$(az network vnet show --resource-group "$RG_NAME" --name "$VNET_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$VNET_ID" ]; then
                echo "üåê Importando Virtual Network: $VNET_NAME"
                terraform import module.aks.azurerm_virtual_network.main "$VNET_ID" 2>&1 || echo "VNet ya en estado"
              fi
              
              # Importar Subnets
              SUBNET_AKS_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_AKS_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$SUBNET_AKS_ID" ]; then
                echo "üîó Importando Subnet AKS: $SUBNET_AKS_NAME"
                terraform import module.aks.azurerm_subnet.aks "$SUBNET_AKS_ID" 2>&1 || echo "Subnet AKS ya en estado"
              fi
              
              SUBNET_NODES_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_NODES_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$SUBNET_NODES_ID" ]; then
                echo "üîó Importando Subnet Nodes: $SUBNET_NODES_NAME"
                terraform import module.aks.azurerm_subnet.nodes "$SUBNET_NODES_ID" 2>&1 || echo "Subnet Nodes ya en estado"
              fi
              
              # Importar AKS Cluster
              AKS_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.ContainerService/managedClusters/$AKS_CLUSTER_NAME"
              if az aks show --resource-group "$RG_NAME" --name "$AKS_CLUSTER_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                echo "‚ò∏Ô∏è Importando AKS Cluster: $AKS_CLUSTER_NAME"
                terraform import module.aks.azurerm_kubernetes_cluster.main "$AKS_ID" 2>&1 || echo "AKS Cluster ya en estado"
              fi
              
              # Importar Log Analytics Workspace (si existe)
              LAW_NAME="ecommerce-law-${ENV}"
              LAW_ID=$(az monitor log-analytics workspace show --resource-group "$RG_NAME" --workspace-name "$LAW_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$LAW_ID" ]; then
                echo "üìä Importando Log Analytics Workspace: $LAW_NAME"
                terraform import 'module.aks.azurerm_log_analytics_workspace.main[0]' "$LAW_ID" 2>&1 || echo "Log Analytics ya en estado"
              fi
              
              # Importar Recovery Services Vault (si existe)
              RSV_NAME="ecommerce-rsv-${ENV}"
              RSV_ID=$(az backup vault show --resource-group "$RG_NAME" --name "$RSV_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$RSV_ID" ]; then
                echo "üíæ Importando Recovery Services Vault: $RSV_NAME"
                terraform import module.aks.azurerm_recovery_services_vault.main[0] "$RSV_ID" 2>&1 || echo "Recovery Services Vault ya en estado"
              fi
              
              echo "üîÑ Re-ejecutando plan despu√©s de importar..."
              terraform plan -var-file=environments/dev/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
              if [ "$PLAN_EXIT_CODE" = "1" ] && grep -q "already exists" plan_output.txt; then
                echo "‚ÑπÔ∏è Algunos recursos a√∫n existen pero no se pueden importar autom√°ticamente"
                echo "‚úÖ Continuando sin cambios (los recursos ya est√°n desplegados)"
                rm -f tfplan
                PLAN_EXIT_CODE=0
              fi
            else
              echo "‚ùå Error en el plan que no es por recursos existentes"
              cat plan_output.txt
              exit 1
            fi
          elif [ "$PLAN_EXIT_CODE" = "2" ]; then
            echo "‚úÖ Plan exitoso - hay cambios que aplicar"
          else
            echo "‚úÖ Plan exitoso - no hay cambios (la infraestructura est√° actualizada)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Verify Plan File
        run: |
          if [ ! -f tfplan ]; then
            echo "‚ÑπÔ∏è No hay cambios que aplicar - la infraestructura ya est√° desplegada y actualizada"
            echo "‚úÖ Saltando apply (no se requiere acci√≥n)"
            exit 0
          fi
          echo "‚úÖ Plan file creado - hay cambios que aplicar"

      - name: Terraform Apply
        id: apply
        run: |
          if [ -f tfplan ]; then
            echo "üöÄ Aplicando cambios de Terraform..."
            terraform apply -auto-approve tfplan
            APPLY_EXIT_CODE=$?
            if [ "$APPLY_EXIT_CODE" -eq 0 ]; then
              echo "‚úÖ Cambios aplicados exitosamente"
            else
              echo "‚ùå Error al aplicar cambios (c√≥digo: $APPLY_EXIT_CODE)"
              exit $APPLY_EXIT_CODE
            fi
          else
            echo "‚ÑπÔ∏è No hay cambios que aplicar - saltando apply"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Saved to Backend
        run: |
          echo "üîç Verificando que el estado se guard√≥ en el backend remoto..."
          echo "üìã Listando recursos en el estado:"
          terraform state list
          echo ""
          echo "‚úÖ Estado verificado - se guard√≥ en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/dev/terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Output
        id: output
        run: terraform output -json
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  terraform-apply-stage:
    name: Deploy Stage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'stage')
    environment:
      name: stage
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "‚ùå Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "‚ùå Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "‚ùå Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          echo "üîß Inicializando Terraform con backend remoto..."
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=stage/terraform.tfstate" \
            -reconfigure
          echo "‚úÖ Terraform inicializado"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify Backend Configuration
        run: |
          echo "üîç Verificando configuraci√≥n del backend..."
          if [ -f .terraform/terraform.tfstate ]; then
            echo "‚úÖ Backend configurado correctamente"
            echo "üìã Informaci√≥n del backend:"
            cat .terraform/terraform.tfstate | grep -A 10 "backend" || echo "Backend configurado (detalles en logs de init)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ archivo de estado del backend"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "‚úÖ Estado encontrado con recursos existentes"
            terraform state list
          else
            echo "‚ÑπÔ∏è Estado vac√≠o o no existe (primera ejecuci√≥n)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Check and Import Existing Resources
        run: |
          echo "üîç Verificando si hay recursos existentes que necesitan ser importados..."
          
          ENV="stage"
          RG_NAME="ecommerce-rg-${ENV}"
          VNET_NAME="ecommerce-vnet-${ENV}"
          SUBNET_AKS_NAME="ecommerce-subnet-aks-${ENV}"
          SUBNET_NODES_NAME="ecommerce-subnet-nodes-${ENV}"
          AKS_CLUSTER_NAME="aks-cluster-${ENV}"
          
          # Verificar si el Resource Group existe
          if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
            echo "‚úÖ Resource Group existe: $RG_NAME"
            
            # Verificar si el AKS Cluster existe
            if az aks show --resource-group "$RG_NAME" --name "$AKS_CLUSTER_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
              echo "‚ö†Ô∏è AKS Cluster existe pero puede no estar en el estado de Terraform"
              echo "üîÑ Verificando estado actual de Terraform..."
              
              # Verificar si el recurso est√° en el estado
              if ! terraform state show module.aks.azurerm_kubernetes_cluster.main 2>/dev/null | grep -q .; then
                echo "üì¶ El AKS Cluster no est√° en el estado - importando recursos..."
                
                # Importar Resource Group
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "üì¶ Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado o error"
                
                # Importar Virtual Network
                VNET_ID=$(az network vnet show --resource-group "$RG_NAME" --name "$VNET_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$VNET_ID" ]; then
                  echo "üåê Importando Virtual Network: $VNET_NAME"
                  terraform import module.aks.azurerm_virtual_network.main "$VNET_ID" 2>&1 || echo "VNet ya en estado o error"
                fi
                
                # Importar Subnets
                SUBNET_AKS_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_AKS_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$SUBNET_AKS_ID" ]; then
                  echo "üîó Importando Subnet AKS: $SUBNET_AKS_NAME"
                  terraform import module.aks.azurerm_subnet.aks "$SUBNET_AKS_ID" 2>&1 || echo "Subnet AKS ya en estado o error"
                fi
                
                SUBNET_NODES_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_NODES_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$SUBNET_NODES_ID" ]; then
                  echo "üîó Importando Subnet Nodes: $SUBNET_NODES_NAME"
                  terraform import module.aks.azurerm_subnet.nodes "$SUBNET_NODES_ID" 2>&1 || echo "Subnet Nodes ya en estado o error"
                fi
                
                # Importar AKS Cluster
                AKS_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.ContainerService/managedClusters/$AKS_CLUSTER_NAME"
                echo "‚ò∏Ô∏è Importando AKS Cluster: $AKS_CLUSTER_NAME"
                terraform import module.aks.azurerm_kubernetes_cluster.main "$AKS_ID" 2>&1 || echo "AKS Cluster ya en estado o error"
                
                # Importar Log Analytics Workspace (si existe)
                LAW_NAME="ecommerce-law-${ENV}"
                LAW_ID=$(az monitor log-analytics workspace show --resource-group "$RG_NAME" --workspace-name "$LAW_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$LAW_ID" ]; then
                  echo "üìä Importando Log Analytics Workspace: $LAW_NAME"
                  terraform import 'module.aks.azurerm_log_analytics_workspace.main[0]' "$LAW_ID" 2>&1 || echo "Log Analytics ya en estado o error"
                fi
                
                # Importar Recovery Services Vault (si existe)
                RSV_NAME="ecommerce-rsv-${ENV}"
                RSV_ID=$(az backup vault show --resource-group "$RG_NAME" --name "$RSV_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$RSV_ID" ]; then
                  echo "üíæ Importando Recovery Services Vault: $RSV_NAME"
                  terraform import module.aks.azurerm_recovery_services_vault.main[0] "$RSV_ID" 2>&1 || echo "Recovery Services Vault ya en estado o error"
                fi
                
                echo "‚úÖ Recursos importados - el estado ahora est√° sincronizado"
              else
                echo "‚úÖ AKS Cluster ya est√° en el estado de Terraform"
              fi
            else
              echo "‚ÑπÔ∏è AKS Cluster no existe en Azure - ser√° creado"
            fi
          else
            echo "‚ÑπÔ∏è Resource Group no existe - ser√° creado"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -var-file=environments/stage/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
          if [ "$PLAN_EXIT_CODE" = "1" ]; then
            if grep -q "already exists" plan_output.txt; then
              echo "‚ö†Ô∏è Detectados recursos existentes que no est√°n en el estado"
              echo "üîÑ Intentando importar recursos existentes..."
              
              ENV="stage"
              RG_NAME="ecommerce-rg-${ENV}"
              VNET_NAME="ecommerce-vnet-${ENV}"
              SUBNET_AKS_NAME="ecommerce-subnet-aks-${ENV}"
              SUBNET_NODES_NAME="ecommerce-subnet-nodes-${ENV}"
              AKS_CLUSTER_NAME="aks-cluster-${ENV}"
              
              # Importar Resource Group
              if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "üì¶ Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado"
              fi
              
              # Importar Virtual Network
              VNET_ID=$(az network vnet show --resource-group "$RG_NAME" --name "$VNET_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$VNET_ID" ]; then
                echo "üåê Importando Virtual Network: $VNET_NAME"
                terraform import module.aks.azurerm_virtual_network.main "$VNET_ID" 2>&1 || echo "VNet ya en estado"
              fi
              
              # Importar Subnets
              SUBNET_AKS_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_AKS_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$SUBNET_AKS_ID" ]; then
                echo "üîó Importando Subnet AKS: $SUBNET_AKS_NAME"
                terraform import module.aks.azurerm_subnet.aks "$SUBNET_AKS_ID" 2>&1 || echo "Subnet AKS ya en estado"
              fi
              
              SUBNET_NODES_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_NODES_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$SUBNET_NODES_ID" ]; then
                echo "üîó Importando Subnet Nodes: $SUBNET_NODES_NAME"
                terraform import module.aks.azurerm_subnet.nodes "$SUBNET_NODES_ID" 2>&1 || echo "Subnet Nodes ya en estado"
              fi
              
              # Importar AKS Cluster
              AKS_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.ContainerService/managedClusters/$AKS_CLUSTER_NAME"
              if az aks show --resource-group "$RG_NAME" --name "$AKS_CLUSTER_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                echo "‚ò∏Ô∏è Importando AKS Cluster: $AKS_CLUSTER_NAME"
                terraform import module.aks.azurerm_kubernetes_cluster.main "$AKS_ID" 2>&1 || echo "AKS Cluster ya en estado"
              fi
              
              # Importar Log Analytics Workspace (si existe)
              LAW_NAME="ecommerce-law-${ENV}"
              LAW_ID=$(az monitor log-analytics workspace show --resource-group "$RG_NAME" --workspace-name "$LAW_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$LAW_ID" ]; then
                echo "üìä Importando Log Analytics Workspace: $LAW_NAME"
                terraform import 'module.aks.azurerm_log_analytics_workspace.main[0]' "$LAW_ID" 2>&1 || echo "Log Analytics ya en estado"
              fi
              
              # Importar Recovery Services Vault (si existe)
              RSV_NAME="ecommerce-rsv-${ENV}"
              RSV_ID=$(az backup vault show --resource-group "$RG_NAME" --name "$RSV_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$RSV_ID" ]; then
                echo "üíæ Importando Recovery Services Vault: $RSV_NAME"
                terraform import module.aks.azurerm_recovery_services_vault.main[0] "$RSV_ID" 2>&1 || echo "Recovery Services Vault ya en estado"
              fi
              
              echo "üîÑ Re-ejecutando plan despu√©s de importar..."
              terraform plan -var-file=environments/stage/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
              if [ "$PLAN_EXIT_CODE" = "1" ] && grep -q "already exists" plan_output.txt; then
                echo "‚ÑπÔ∏è Algunos recursos a√∫n existen pero no se pueden importar autom√°ticamente"
                echo "‚úÖ Continuando sin cambios (los recursos ya est√°n desplegados)"
                rm -f tfplan
                PLAN_EXIT_CODE=0
              fi
            else
              echo "‚ùå Error en el plan que no es por recursos existentes"
              cat plan_output.txt
              exit 1
            fi
          elif [ "$PLAN_EXIT_CODE" = "2" ]; then
            echo "‚úÖ Plan exitoso - hay cambios que aplicar"
          else
            echo "‚úÖ Plan exitoso - no hay cambios (la infraestructura est√° actualizada)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Verify Plan File
        run: |
          if [ ! -f tfplan ]; then
            echo "‚ÑπÔ∏è No hay cambios que aplicar - la infraestructura ya est√° desplegada y actualizada"
            echo "‚úÖ Saltando apply (no se requiere acci√≥n)"
            exit 0
          fi
          echo "‚úÖ Plan file creado - hay cambios que aplicar"

      - name: Terraform Apply
        id: apply
        run: |
          if [ -f tfplan ]; then
            echo "üöÄ Aplicando cambios de Terraform..."
            terraform apply -auto-approve tfplan
            APPLY_EXIT_CODE=$?
            if [ "$APPLY_EXIT_CODE" -eq 0 ]; then
              echo "‚úÖ Cambios aplicados exitosamente"
            else
              echo "‚ùå Error al aplicar cambios (c√≥digo: $APPLY_EXIT_CODE)"
              exit $APPLY_EXIT_CODE
            fi
          else
            echo "‚ÑπÔ∏è No hay cambios que aplicar - saltando apply"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Saved to Backend
        run: |
          echo "üîç Verificando que el estado se guard√≥ en el backend remoto..."
          echo "üìã Listando recursos en el estado:"
          terraform state list
          echo ""
          echo "‚úÖ Estado verificado - se guard√≥ en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/stage/terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Output
        id: output
        run: terraform output -json
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

  terraform-apply-prod:
    name: Deploy Prod
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment:
      name: prod
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" ]; then
            echo "‚ùå Error: AZURE_STATE_RESOURCE_GROUP secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" ]; then
            echo "‚ùå Error: AZURE_STATE_STORAGE_ACCOUNT secret is missing"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_STATE_CONTAINER }}" ]; then
            echo "‚ùå Error: AZURE_STATE_CONTAINER secret is missing"
            exit 1
          fi
          echo "‚úÖ All required secrets are configured"

      - name: Terraform Init
        id: init
        run: |
          echo "üîß Inicializando Terraform con backend remoto..."
          terraform init \
            -backend-config="resource_group_name=${{ secrets.AZURE_STATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.AZURE_STATE_CONTAINER }}" \
            -backend-config="key=prod/terraform.tfstate" \
            -reconfigure
          echo "‚úÖ Terraform inicializado"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify Backend Configuration
        run: |
          echo "üîç Verificando configuraci√≥n del backend..."
          if [ -f .terraform/terraform.tfstate ]; then
            echo "‚úÖ Backend configurado correctamente"
            echo "üìã Informaci√≥n del backend:"
            cat .terraform/terraform.tfstate | grep -A 10 "backend" || echo "Backend configurado (detalles en logs de init)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ archivo de estado del backend"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Check State
        run: |
          if terraform state list 2>/dev/null | grep -q .; then
            echo "‚úÖ Estado encontrado con recursos existentes"
            terraform state list
          else
            echo "‚ÑπÔ∏è Estado vac√≠o o no existe (primera ejecuci√≥n)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Setup Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az login --service-principal \
            -u "$ARM_CLIENT_ID" \
            -p "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Check and Import Existing Resources
        run: |
          echo "üîç Verificando si hay recursos existentes que necesitan ser importados..."
          
          ENV="prod"
          RG_NAME="ecommerce-rg-${ENV}"
          VNET_NAME="ecommerce-vnet-${ENV}"
          SUBNET_AKS_NAME="ecommerce-subnet-aks-${ENV}"
          SUBNET_NODES_NAME="ecommerce-subnet-nodes-${ENV}"
          AKS_CLUSTER_NAME="aks-cluster-${ENV}"
          
          # Verificar si el Resource Group existe
          if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
            echo "‚úÖ Resource Group existe: $RG_NAME"
            
            # Verificar si el AKS Cluster existe
            if az aks show --resource-group "$RG_NAME" --name "$AKS_CLUSTER_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
              echo "‚ö†Ô∏è AKS Cluster existe pero puede no estar en el estado de Terraform"
              echo "üîÑ Verificando estado actual de Terraform..."
              
              # Verificar si el recurso est√° en el estado
              if ! terraform state show module.aks.azurerm_kubernetes_cluster.main 2>/dev/null | grep -q .; then
                echo "üì¶ El AKS Cluster no est√° en el estado - importando recursos..."
                
                # Importar Resource Group
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "üì¶ Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado o error"
                
                # Importar Virtual Network
                VNET_ID=$(az network vnet show --resource-group "$RG_NAME" --name "$VNET_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$VNET_ID" ]; then
                  echo "üåê Importando Virtual Network: $VNET_NAME"
                  terraform import module.aks.azurerm_virtual_network.main "$VNET_ID" 2>&1 || echo "VNet ya en estado o error"
                fi
                
                # Importar Subnets
                SUBNET_AKS_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_AKS_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$SUBNET_AKS_ID" ]; then
                  echo "üîó Importando Subnet AKS: $SUBNET_AKS_NAME"
                  terraform import module.aks.azurerm_subnet.aks "$SUBNET_AKS_ID" 2>&1 || echo "Subnet AKS ya en estado o error"
                fi
                
                SUBNET_NODES_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_NODES_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$SUBNET_NODES_ID" ]; then
                  echo "üîó Importando Subnet Nodes: $SUBNET_NODES_NAME"
                  terraform import module.aks.azurerm_subnet.nodes "$SUBNET_NODES_ID" 2>&1 || echo "Subnet Nodes ya en estado o error"
                fi
                
                # Importar AKS Cluster
                AKS_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.ContainerService/managedClusters/$AKS_CLUSTER_NAME"
                echo "‚ò∏Ô∏è Importando AKS Cluster: $AKS_CLUSTER_NAME"
                terraform import module.aks.azurerm_kubernetes_cluster.main "$AKS_ID" 2>&1 || echo "AKS Cluster ya en estado o error"
                
                # Importar Log Analytics Workspace (si existe)
                LAW_NAME="ecommerce-law-${ENV}"
                LAW_ID=$(az monitor log-analytics workspace show --resource-group "$RG_NAME" --workspace-name "$LAW_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$LAW_ID" ]; then
                  echo "üìä Importando Log Analytics Workspace: $LAW_NAME"
                  terraform import 'module.aks.azurerm_log_analytics_workspace.main[0]' "$LAW_ID" 2>&1 || echo "Log Analytics ya en estado o error"
                fi
                
                # Importar Recovery Services Vault (si existe)
                RSV_NAME="ecommerce-rsv-${ENV}"
                RSV_ID=$(az backup vault show --resource-group "$RG_NAME" --name "$RSV_NAME" --query id -o tsv 2>/dev/null)
                if [ -n "$RSV_ID" ]; then
                  echo "üíæ Importando Recovery Services Vault: $RSV_NAME"
                  terraform import module.aks.azurerm_recovery_services_vault.main[0] "$RSV_ID" 2>&1 || echo "Recovery Services Vault ya en estado o error"
                fi
                
                echo "‚úÖ Recursos importados - el estado ahora est√° sincronizado"
              else
                echo "‚úÖ AKS Cluster ya est√° en el estado de Terraform"
              fi
            else
              echo "‚ÑπÔ∏è AKS Cluster no existe en Azure - ser√° creado"
            fi
          else
            echo "‚ÑπÔ∏è Resource Group no existe - ser√° creado"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -var-file=environments/prod/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
          if [ "$PLAN_EXIT_CODE" = "1" ]; then
            if grep -q "already exists" plan_output.txt; then
              echo "‚ö†Ô∏è Detectados recursos existentes que no est√°n en el estado"
              echo "üîÑ Intentando importar recursos existentes..."
              
              ENV="prod"
              RG_NAME="ecommerce-rg-${ENV}"
              VNET_NAME="ecommerce-vnet-${ENV}"
              SUBNET_AKS_NAME="ecommerce-subnet-aks-${ENV}"
              SUBNET_NODES_NAME="ecommerce-subnet-nodes-${ENV}"
              AKS_CLUSTER_NAME="aks-cluster-${ENV}"
              
              # Importar Resource Group
              if az group show --name "$RG_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                RG_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME"
                echo "üì¶ Importando Resource Group: $RG_NAME"
                terraform import module.aks.azurerm_resource_group.main "$RG_ID" 2>&1 || echo "Resource Group ya en estado"
              fi
              
              # Importar Virtual Network
              VNET_ID=$(az network vnet show --resource-group "$RG_NAME" --name "$VNET_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$VNET_ID" ]; then
                echo "üåê Importando Virtual Network: $VNET_NAME"
                terraform import module.aks.azurerm_virtual_network.main "$VNET_ID" 2>&1 || echo "VNet ya en estado"
              fi
              
              # Importar Subnets
              SUBNET_AKS_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_AKS_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$SUBNET_AKS_ID" ]; then
                echo "üîó Importando Subnet AKS: $SUBNET_AKS_NAME"
                terraform import module.aks.azurerm_subnet.aks "$SUBNET_AKS_ID" 2>&1 || echo "Subnet AKS ya en estado"
              fi
              
              SUBNET_NODES_ID=$(az network vnet subnet show --resource-group "$RG_NAME" --vnet-name "$VNET_NAME" --name "$SUBNET_NODES_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$SUBNET_NODES_ID" ]; then
                echo "üîó Importando Subnet Nodes: $SUBNET_NODES_NAME"
                terraform import module.aks.azurerm_subnet.nodes "$SUBNET_NODES_ID" 2>&1 || echo "Subnet Nodes ya en estado"
              fi
              
              # Importar AKS Cluster
              AKS_ID="/subscriptions/$ARM_SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.ContainerService/managedClusters/$AKS_CLUSTER_NAME"
              if az aks show --resource-group "$RG_NAME" --name "$AKS_CLUSTER_NAME" --query id -o tsv 2>/dev/null | grep -q .; then
                echo "‚ò∏Ô∏è Importando AKS Cluster: $AKS_CLUSTER_NAME"
                terraform import module.aks.azurerm_kubernetes_cluster.main "$AKS_ID" 2>&1 || echo "AKS Cluster ya en estado"
              fi
              
              # Importar Log Analytics Workspace (si existe)
              LAW_NAME="ecommerce-law-${ENV}"
              LAW_ID=$(az monitor log-analytics workspace show --resource-group "$RG_NAME" --workspace-name "$LAW_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$LAW_ID" ]; then
                echo "üìä Importando Log Analytics Workspace: $LAW_NAME"
                terraform import 'module.aks.azurerm_log_analytics_workspace.main[0]' "$LAW_ID" 2>&1 || echo "Log Analytics ya en estado"
              fi
              
              # Importar Recovery Services Vault (si existe)
              RSV_NAME="ecommerce-rsv-${ENV}"
              RSV_ID=$(az backup vault show --resource-group "$RG_NAME" --name "$RSV_NAME" --query id -o tsv 2>/dev/null)
              if [ -n "$RSV_ID" ]; then
                echo "üíæ Importando Recovery Services Vault: $RSV_NAME"
                terraform import module.aks.azurerm_recovery_services_vault.main[0] "$RSV_ID" 2>&1 || echo "Recovery Services Vault ya en estado"
              fi
              
              echo "üîÑ Re-ejecutando plan despu√©s de importar..."
              terraform plan -var-file=environments/prod/terraform.tfvars -out=tfplan -detailed-exitcode 2>&1 | tee plan_output.txt || PLAN_EXIT_CODE=$?
              if [ "$PLAN_EXIT_CODE" = "1" ] && grep -q "already exists" plan_output.txt; then
                echo "‚ÑπÔ∏è Algunos recursos a√∫n existen pero no se pueden importar autom√°ticamente"
                echo "‚úÖ Continuando sin cambios (los recursos ya est√°n desplegados)"
                rm -f tfplan
                PLAN_EXIT_CODE=0
              fi
            else
              echo "‚ùå Error en el plan que no es por recursos existentes"
              cat plan_output.txt
              exit 1
            fi
          elif [ "$PLAN_EXIT_CODE" = "2" ]; then
            echo "‚úÖ Plan exitoso - hay cambios que aplicar"
          else
            echo "‚úÖ Plan exitoso - no hay cambios (la infraestructura est√° actualizada)"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Verify Plan File
        run: |
          if [ ! -f tfplan ]; then
            echo "‚ÑπÔ∏è No hay cambios que aplicar - la infraestructura ya est√° desplegada y actualizada"
            echo "‚úÖ Saltando apply (no se requiere acci√≥n)"
            exit 0
          fi
          echo "‚úÖ Plan file creado - hay cambios que aplicar"

      - name: Terraform Apply
        id: apply
        run: |
          if [ -f tfplan ]; then
            echo "üöÄ Aplicando cambios de Terraform..."
            terraform apply -auto-approve tfplan
            APPLY_EXIT_CODE=$?
            if [ "$APPLY_EXIT_CODE" -eq 0 ]; then
              echo "‚úÖ Cambios aplicados exitosamente"
            else
              echo "‚ùå Error al aplicar cambios (c√≥digo: $APPLY_EXIT_CODE)"
              exit $APPLY_EXIT_CODE
            fi
          else
            echo "‚ÑπÔ∏è No hay cambios que aplicar - saltando apply"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Verify State Saved to Backend
        run: |
          echo "üîç Verificando que el estado se guard√≥ en el backend remoto..."
          echo "üìã Listando recursos en el estado:"
          terraform state list
          echo ""
          echo "‚úÖ Estado verificado - se guard√≥ en Azure Storage: ${{ secrets.AZURE_STATE_STORAGE_ACCOUNT }}/${{ secrets.AZURE_STATE_CONTAINER }}/prod/terraform.tfstate"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        continue-on-error: true

      - name: Terraform Output
        id: output
        run: terraform output -json
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
